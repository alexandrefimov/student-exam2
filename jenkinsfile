node("jenkins-slave") {
    cleanWs()
    def app_calc
    stage('Upload app Repo') {
        git credentialsId: 'ssh-git-key', url: 'git@github.com:alexandrefimov/student-exam2.git', branch: 'exam'
    }
    stage('Run Python Test') {
        sh """
        python3 -m venv venv
        . venv/bin/activate
        pip install -e '.[test]'
        coverage run -m pytest
        coverage report
        """
    }
    stage('Build Jenkins Slave Image') {
        app_calc = docker.build('alexanderefimov/exam_images:app_calc${env.BUILD_ID}')
    }
    stage('Login to DockerHub') {
        docker.withRegistry('', 'dockerhub') {
            app_calc.push()
        }
    }
}

